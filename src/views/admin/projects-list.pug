doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Manage Projects - Admin
    link(rel="stylesheet" href="/css/main.css")
    link(rel="stylesheet" href="/css/admin.css")
  body.admin-page
    include ../partials/admin-header

    .admin-container
      aside.admin-sidebar
        nav.admin-nav
          a.nav-item(href="/admin/projects" class="active")
            span Projects
          a.nav-item(href="/admin/achievements")
            span Achievements
          a.nav-item(href="/")
            span View Site
          a.nav-item.logout(href="/admin/logout")
            span Logout

      main.admin-main
        .admin-header
          h1 Manage Projects
          a.btn.btn-primary(href="/admin/projects/create") + New Project

        if success
          .alert.alert-success= success

        if projects && projects.length > 0
          .admin-table-container
            table.admin-table
              thead
                tr
                  th ID
                  th Title
                  th Company
                  th Start Date
                  th End Date
                  th Technologies
                  th Actions
              tbody
                each project in projects
                  tr
                    td= project.id
                    td= project.title
                    td= project.company || '-'
                    td= project.startDate ? new Date(project.startDate).toLocaleDateString() : '-'
                    td= project.endDate ? new Date(project.endDate).toLocaleDateString() : 'Present'
                    td
                      if project.technologies && project.technologies.length > 0
                        = project.technologies.slice(0, 3).join(', ')
                        if project.technologies.length > 3
                          | ...
                      else
                        | -
                    td.table-actions
                      a.btn.btn-sm.btn-secondary(href=`/admin/projects/${project.id}/edit`) Edit
                      button.btn.btn-sm.btn-danger.delete-btn(
                        data-id=project.id
                        data-title=project.title
                        type="button"
                      ) Delete

          if pagination && pagination.totalPages > 1
            .pagination
              if pagination.page > 1
                a.pagination-link(href=`/admin/projects?page=${pagination.page - 1}`) Previous

              - var startPage = Math.max(1, pagination.page - 2)
              - var endPage = Math.min(pagination.totalPages, pagination.page + 2)

              each pageNum in Array.from({length: endPage - startPage + 1}, (_, i) => startPage + i)
                if pageNum === pagination.page
                  span.pagination-link.active= pageNum
                else
                  a.pagination-link(href=`/admin/projects?page=${pageNum}`)= pageNum

              if pagination.page < pagination.totalPages
                a.pagination-link(href=`/admin/projects?page=${pagination.page + 1}`) Next

          .results-info
            p Showing #{projects.length} of #{pagination.total} projects
        else
          p.empty-state No projects found.

    script(src="/js/api.js")
    script(src="/js/main.js")
    script(src="/js/admin.js")
    script.
      // Delete project handler
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.dataset.id;
          const title = this.dataset.title;

          if (!confirm(`Are you sure you want to delete "${title}"?`)) {
            return;
          }

          // Disable button during deletion
          const originalText = this.textContent;
          this.disabled = true;
          this.textContent = 'Deleting...';

          try {
            // Use API module
            await API.projects.delete(id);
            showToast(`Project "${title}" deleted successfully!`, 'success');

            // Reload after short delay
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } catch (error) {
            showToast(error.message || 'Failed to delete project', 'error');
            // Re-enable button
            this.disabled = false;
            this.textContent = originalText;
          }
        });
      });
